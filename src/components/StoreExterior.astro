<h1>Welcome to the Store! CLICK GREY RECTANGLE TO CONTINUE</h1>

<div class="store-exterior">
  <div class="parallax-container">
    <!-- background image -->
    <img
      src="https://raw.githubusercontent.com/NeonAdNauseam/Portfolio-API-and-Images/main/nonportfolioAssets/konbiniexample.png"
      alt="Street background"
      class="scene-bg"
    />

    <!-- Track 1 -->
    <svg
      class="parallax-track"
      id="track1Svg"
      viewBox="0 0 1920 1080"
      preserveAspectRatio="xMidYMid slice"
    >
      <defs>
        <g id="shapeCTrack1" clip-path="url(#clip0_22_160)">
          <path
            d="M802.978 264.685C796.065 188.52 712.115 168.738 712.115 168.738V131.151C716.066 113.345 701.25 119.282 701.25 119.282L497.793 114.336L494.831 43.1164C496.806 37.1802 530.385 26.3016 530.385 26.3016C362.485 -13.2673 174.831 3.55051 174.831 3.55051C63.2268 -0.406951 53.3511 33.2228 53.3511 33.2228C21.7451 68.8312 55.3268 181.596 55.3268 181.596C-31.5881 134.118 9.8936 316.12 9.8936 316.12C45.4481 301.284 44.4617 308.208 44.4617 308.208C49.3996 366.568 88.9056 382.395 88.9056 382.395C163.966 406.134 190.634 346.786 190.634 346.786C273.598 400.201 293.349 320.078 293.349 320.078C347.669 335.905 590.632 308.208 590.632 308.208C593.594 331.947 608.411 346.786 608.411 346.786C658.782 418.994 738.78 364.592 738.78 364.592C822.73 354.701 802.978 264.685 802.978 264.685ZM110.636 114.333C88.9085 116.312 99.7707 76.7462 99.7707 76.7462C100.757 42.1256 142.239 49.0497 142.239 49.0497L143.225 110.376L110.636 114.333ZM297.301 113.345L195.572 114.333L194.586 47.071H297.301V113.345ZM309.152 113.345L310.139 47.071L419.767 51.0285L421.743 112.355L309.149 113.343L309.152 113.345ZM479.028 109.388L443.473 113.345L444.459 68.8341C441.497 41.1377 479.028 42.1285 479.028 42.1285V109.388Z"
            fill="black"
          />
        </g>
        <clipPath id="clip0_22_160">
          <rect width="805" height="388" fill="white" />
        </clipPath>
      </defs>
    </svg>

    <!-- Track 2 -->
    <svg
      class="parallax-track"
      id="track2Svg"
      viewBox="0 0 1920 1080"
      preserveAspectRatio="xMidYMid slice"
    >
      <defs>
        <g id="shapeCTrack2" clip-path="url(#clip0_22_160)">
          <path
            d="M802.978 264.685C796.065 188.52 712.115 168.738 712.115 168.738V131.151C716.066 113.345 701.25 119.282 701.25 119.282L497.793 114.336L494.831 43.1164C496.806 37.1802 530.385 26.3016 530.385 26.3016C362.485 -13.2673 174.831 3.55051 174.831 3.55051C63.2268 -0.406951 53.3511 33.2228 53.3511 33.2228C21.7451 68.8312 55.3268 181.596 55.3268 181.596C-31.5881 134.118 9.8936 316.12 9.8936 316.12C45.4481 301.284 44.4617 308.208 44.4617 308.208C49.3996 366.568 88.9056 382.395 88.9056 382.395C163.966 406.134 190.634 346.786 190.634 346.786C273.598 400.201 293.349 320.078 293.349 320.078C347.669 335.905 590.632 308.208 590.632 308.208C593.594 331.947 608.411 346.786 608.411 346.786C658.782 418.994 738.78 364.592 738.78 364.592C822.73 354.701 802.978 264.685 802.978 264.685ZM110.636 114.333C88.9085 116.312 99.7707 76.7462 99.7707 76.7462C100.757 42.1256 142.239 49.0497 142.239 49.0497L143.225 110.376L110.636 114.333ZM297.301 113.345L195.572 114.333L194.586 47.071H297.301V113.345ZM309.152 113.345L310.139 47.071L419.767 51.0285L421.743 112.355L309.149 113.343L309.152 113.345ZM479.028 109.388L443.473 113.345L444.459 68.8341C441.497 41.1377 479.028 42.1285 479.028 42.1285V109.388Z"
            fill="green"
          />
        </g>
        <clipPath id="clip0_22_160">
          <rect width="805" height="388" fill="white" />
        </clipPath>
      </defs>
    </svg>

    <!-- Konbini on top of the scene -->
    <div class="konbini-wrapper">
      <svg
        class="konbini"
        viewBox="0 0 375 376"
        width="300"
        xmlns="http://www.w3.org/2000/svg"
      >
        <rect width="375" height="376" fill="#E5444450" />
        <rect
          class="door"
          x="133"
          y="193"
          width="89"
          height="183"
          fill="#D9D9D950"
          id="enter-door"
        />
      </svg>
    </div>
  </div>
</div>

<style>
:root {
  --store-bg: #000000;
  --store-text-color: #000000;
  --store-font-family: Arial, sans-serif;
  --store-transition-duration: 0.8s;

  /* make everything positive so it lives ABOVE the background */
  --scene-bg-z: 1;
  --track1-z: 3;
  --track2-z: 2;
  --konbini-z: 10;
}

  h1 {
    color: var(--store-text-color);
    text-align: center;
    margin-top: 2rem;
    font-family: var(--store-font-family);
  }

  .store-exterior {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    background: var(--store-bg);
    transition: opacity var(--store-transition-duration) ease;

    .parallax-container {
      position: relative;
      width: 100%;
      height: 100vh;
      overflow: hidden;

      .scene-bg {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: var(--scene-bg-fit);
        object-position: var(--scene-bg-position);
        z-index: var(--scene-bg-z);
        pointer-events: none;
      }

      .parallax-track {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }

      #track1Svg {
        z-index: var(--track1-z);
      }

      #track2Svg {
        z-index: var(--track2-z);
      }

      .konbini-wrapper {
        position: relative;
        z-index: var(--konbini-z);
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;

        .konbini {
          display: block;
        }

        .door {
          cursor: pointer;
        }
      }
    }
  }

  body[data-screen="interior"] .store-exterior {
    opacity: 0;
    pointer-events: none;
  }
</style>

<script is:inline>
  // --------------------------------------------------------
  // click door to enter store
  // --------------------------------------------------------
  window.addEventListener("DOMContentLoaded", () => {
    const door = document.getElementById("enter-door");
    if (door) {
      door.addEventListener("click", () => {
        document.dispatchEvent(new CustomEvent("enter-store"));
      });
    }
  });

  // --------------------------------------------------------
  // Car lane logic (uses global gsap)
  // --------------------------------------------------------

  const trackShapes = {
    track1: ["shapeCTrack1"],
    track2: ["shapeCTrack2"]
  };

  const trackDirections = {
    track1: "right",
    track2: "left"
  };

  const lastSpawnedMap = {
    track1: null,
    track2: null
  };

  const BASE_DISTANCE = 2300;

  function randomInRange(min, max) {
    return min + Math.random() * (max - min);
  }

  const trackConfig = {
    track1: {
      scale: 1.25,
      y: 650,
      speed: 8,
      minDelay: 4000,
      maxDelay: 16000
    },
    track2: {
      scale: 0.75,
      y: 575,
      speed: 7,
      minDelay: 4000,
      maxDelay: 16000
    }
  };

  function spawnSmokeStack(svgRoot, scaleFactor, speedSec, yOffsets) {
    if (!svgRoot || !window.gsap) return;

    const trackId = svgRoot.getAttribute("id"); // "track1Svg"
    const shortId = trackId.replace("Svg", ""); // "track1"

    const possibleShapes = trackShapes[shortId] || [];
    if (!possibleShapes.length) return;

    const direction = trackDirections[shortId] || "right";

    const shapeIndex = Math.floor(Math.random() * possibleShapes.length);
    const randomShapeId = possibleShapes[shapeIndex];

    const template = document.getElementById(randomShapeId);
    if (!template) return;

    const newStack = template.cloneNode(true);
    newStack.removeAttribute("id");
    svgRoot.appendChild(newStack);

    const yPos =
      yOffsets && yOffsets[shapeIndex] !== undefined
        ? yOffsets[shapeIndex]
        : 200;

    const scaleX = direction === "right" ? scaleFactor : -scaleFactor;

    gsap.set(newStack, {
      x: 0,
      y: yPos,
      scaleX: scaleX,
      scaleY: scaleFactor,
      transformOrigin: "top left"
    });

    const newBbox = newStack.getBBox();
    const shapeWidth = newBbox.width * scaleFactor;

    let startX;
    let finalX;

    if (direction === "right") {
      startX = -300 - shapeWidth;
      finalX = 2000;
    } else {
      startX = 2000 + shapeWidth;
      finalX = -300;
    }

    gsap.set(newStack, { x: startX });

    const totalDistance = BASE_DISTANCE + shapeWidth;
    const baseVelocity = BASE_DISTANCE / speedSec;
    const actualDuration = totalDistance / baseVelocity;

    gsap.to(newStack, {
      x: finalX,
      duration: actualDuration,
      ease: "none",
      onComplete: () => {
        newStack.remove();
      }
    });

    lastSpawnedMap[shortId] = newStack;
  }

  function setupParallaxTracks() {
    if (!window.gsap) {
      console.warn("GSAP not found, car animation disabled.");
      return;
    }

    const track1Svg = document.getElementById("track1Svg");
    const track2Svg = document.getElementById("track2Svg");

    function scheduleTrack(svgRoot, trackKey) {
      const cfg = trackConfig[trackKey];
      if (!svgRoot || !cfg) return;

      const spawnAndReschedule = () => {
        spawnSmokeStack(svgRoot, cfg.scale, cfg.speed, [cfg.y]);
        const delay = randomInRange(cfg.minDelay, cfg.maxDelay);
        setTimeout(spawnAndReschedule, delay);
      };

      spawnAndReschedule();
    }

    if (track1Svg) scheduleTrack(track1Svg, "track1");
    if (track2Svg) scheduleTrack(track2Svg, "track2");
  }

  window.addEventListener("DOMContentLoaded", () => {
    setupParallaxTracks();
  });
</script>
